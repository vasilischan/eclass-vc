tinymce.PluginManager.add("eclmedia",function(e,c){function b(f){return function(){var g=e.settings.link_list;if(typeof(g)==="string"){tinymce.util.XHR.send({url:g,success:function(h){f(tinymce.util.JSON.parse(h))}})}else{if(typeof(g)==="function"){g(f)}else{f(g)}}}}function d(h,f,i){function g(k,j){j=j||[];tinymce.each(k,function(m){var l={text:m.text||m.title};if(m.menu){l.menu=g(m.menu)}else{l.value=m.value;if(f){f(l)}}j.push(l)});return j}return g(h,i||[])}function a(j){var x={},y=e.selection,t=e.dom,v,n,o;var i,l,k,h,p,m,q,r;function u(z){var A=i.find("#text");if(!A.value()||(z.lastControl&&A.value()===z.lastControl.text())){A.value(z.control.text())}i.find("#href").value(z.control.value())}function g(z){var A=[];tinymce.each(e.dom.select("a:not([href])"),function(B){var C=B.name||B.id;if(C){A.push({text:C,value:"#"+C,selected:z.indexOf("#"+C)!==-1})}});if(A.length){A.unshift({text:"None",value:""});return{name:"anchor",type:"listbox",label:"Anchors",values:A,onselect:u}}}function s(){if(!o&&x.text.length===0&&l){this.parent().parent().find("#text")[0].value(this.value())}}function f(A){var z=A.meta||{};if(h){h.value(e.convertURL(this.value(),"href"))}tinymce.each(A.meta,function(C,B){i.find("#"+B).value(C)});if(!z.text){s.call(this)}}function w(A){var C=y.getContent();if(/</.test(C)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(C)||C.indexOf("href=")===-1)){return false}if(A){var z=A.childNodes,B;if(z.length===0){return false}for(B=z.length-1;B>=0;B--){if(z[B].nodeType!==3){return false}}}return true}v=y.getNode();n=t.getParent(v,"a[href]");l=w();x.text=o=n?(n.innerText||n.textContent):y.getContent({format:"text"});x.href=n?t.getAttrib(n,"href"):"";if((r=t.getAttrib(n,"target"))){x.target=r}else{if(e.settings.default_link_target){x.target=e.settings.default_link_target}}if((r=t.getAttrib(n,"rel"))){x.rel=r}if((r=t.getAttrib(n,"class"))){x["class"]=r}if((r=t.getAttrib(n,"title"))){x.title=r}if(l){k={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){x.text=this.value()}}}if(j){h={type:"listbox",label:"Link list",values:d(j,function(z){z.value=e.convertURL(z.value||z.url,"href")},[{text:"None",value:""}]),onselect:u,value:e.convertURL(x.href,"href"),onPostRender:function(){h=this}}}if(e.settings.target_list!==false){if(!e.settings.target_list){e.settings.target_list=[{text:"None",value:""},{text:"New window",value:"_blank"}]}m={name:"target",type:"listbox",label:"Target",values:d(e.settings.target_list)}}if(e.settings.rel_list){p={name:"rel",type:"listbox",label:"Rel",values:d(e.settings.rel_list)}}if(e.settings.link_title!==false){q={name:"title",type:"textbox",label:"Title",value:x.title}}i=e.windowManager.open({title:"Insert/Edit Pop-Up Media",data:x,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:true,label:"Url",onchange:f,onkeyup:s},k,q,g(x.href),h,p,m],onSubmit:function(C){var z;x=tinymce.extend(x,C.data);z=x.href;function B(E,F){var D=e.selection.getRng();window.setTimeout(function(){e.windowManager.confirm(E,function(G){e.selection.setRng(D);F(G)})},0)}function A(){var D={href:z,target:x.target?x.target:null,rel:x.rel?x.rel:null,"class":"colorboxframe",title:x.title?x.title:null};if(n){e.focus();if(l&&x.text!==o){if("innerText" in n){n.innerText=x.text}else{n.textContent=x.text}}t.setAttribs(n,D);y.select(n);e.undoManager.add()}else{if(l){e.insertContent(t.createHTML("a",D,t.encode(x.text)))}else{e.execCommand("mceInsertLink",false,D)}}}if(!z){e.execCommand("unlink");return}if(/^\s*www\./i.test(z)){B("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(D){if(D){z="http://"+z}A()});return}A()}})}e.addButton("eclmedia",{image:c+"/img/video.gif",tooltip:"Insert/Edit Pop-Up Media",onclick:b(a),stateSelector:"a[href].colorboxframe"});this.showDialog=a});